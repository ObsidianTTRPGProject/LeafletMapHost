<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaflet Custom Battlemap with Multiple Markers</title>

  <!-- 1) Leaflet CSS (no integrity to avoid SRI issues) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    /* 2) The map container needs an explicit height */
    #map {
      width: 100%;
      height: 600px;
      background: #000; /* fallback if the image fails to load */
    }
  </style>
</head>

<body>
  <!-- 3) Optional heading to confirm the page is loading -->
  <h2 style="text-align: center; margin: 10px 0;">
    Custom Battlemap (66-Road-Encounter-L) with Multiple Obsidian Markers
  </h2>

  <!-- 4) Leaflet map container -->
  <div id="map"></div>

  <!-- 5) Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    // ▮ A) Initialize Leaflet with CRS.Simple (so x/y are pixel coords)
    var map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -1,
      maxZoom: 2
    });

    // ▮ B) The pixel dimensions of your battlemap image
    //    For 66-Road-Encounter-L.jpg, the size is 1100×1130 px.
    var imgWidth  = 1100;
    var imgHeight = 1130;

    // ▮ C) Compute “bounds” in CRS.Simple coordinates:
    //    Top-left = [0, 0], bottom-right = [imgHeight, imgWidth]
    var imageBounds = [[0, 0], [imgHeight, imgWidth]];

    // ▮ D) Add the image overlay to the map
    var battlemap = L.imageOverlay(
      '66-Road-Encounter-L.jpg',
      imageBounds
    ).addTo(map);

    // ▮ E) Center & zoom so the entire image is visible initially
    var centerPoint = L.latLng(imgHeight / 2, imgWidth / 2);
    map.setView(centerPoint, 0);

    // ▮ F) Constrain panning so users cannot drag outside the image
    map.setMaxBounds(imageBounds);
    map.on('drag', function() {
      map.panInsideBounds(imageBounds, { animate: false });
    });

    // ▮ G) (OPTIONAL) Draw a grid overlay if you want a 5-ft grid:
    //    Suppose each square is 50 px on the image. Uncomment & adjust:
    /*
    var gridPixelSize = 50; // e.g. 50 px per 5-ft square

    // Draw vertical lines
    for (var x = 0; x <= imgWidth; x += gridPixelSize) {
      L.polyline(
        [[0, x], [imgHeight, x]],
        { color: '#666', weight: 1, opacity: 0.5 }
      ).addTo(map);
    }
    // Draw horizontal lines
    for (var y = 0; y <= imgHeight; y += gridPixelSize) {
      L.polyline(
        [[y, 0], [y, imgWidth]],
        { color: '#666', weight: 1, opacity: 0.5 }
      ).addTo(map);
    }
    */

    // ▮ H) Embed your Obsidian “data.json” object as a JavaScript variable
    var markerData = {
      "id": "EncounterPublishTest",
      "lastAccessed": 1748933312165,
      "markers": [
        {
          "id": "ID_5858e9398b9a",
          "type": "default",
          "loc": [756, 789.999813031691],
          "layer": "%5B%5B66-Road-Encounter-L.jpg%5D%5D",
          "mutable": true,
          "command": false,
          "percent": [0.7181816482106282, -0.6690265486725664],
          "description": null,
          "minZoom": null,
          "maxZoom": null,
          "tooltip": "hover"
        },
        {
          "id": "ID_4adb583bc92a",
          "type": "default",
          "loc": [434, 776.0014957464709],
          "layer": "%5B%5B66-Road-Encounter-L.jpg%5D%5D",
          "mutable": true,
          "command": false,
          "percent": [0.7054559052240645, -0.384070796460177],
          "description": null,
          "minZoom": null,
          "maxZoom": null,
          "tooltip": "hover"
        },
        {
          "id": "ID_b8f928ab3bb9",
          "type": "default",
          "loc": [560, 352.0011218098532],
          "layer": "%5B%5B66-Road-Encounter-L.jpg%5D%5D",
          "mutable": true,
          "command": false,
          "percent": [0.3200010198271393, -0.49557522123893805],
          "description": null,
          "minZoom": null,
          "maxZoom": null,
          "tooltip": "hover"
        }
      ],
      "overlays": [],
      "shapes": [],
      "files": []
    };

    // ▮ I) Loop through each marker and add to the map
    markerData.markers.forEach(function(m) {
      // 1) Decode “layer” from URI-encoded wiki link to plain filename:
      var decodedLayer = decodeURIComponent(m.layer);
      //    e.g. "[[66-Road-Encounter-L.jpg]]"
      var plainLayerName = decodedLayer.replace(/^\[\[(.*)\]\]$/, '$1');

      // 2) Only place markers on this specific image
      if (plainLayerName === '66-Road-Encounter-L.jpg') {
        // JSON “loc” = [pixelX, pixelY]
        var pixelX = m.loc[0];
        var pixelY = m.loc[1];

        // For CRS.Simple, Leaflet’s latLng is [pixelY, pixelX]
        var latlng = L.latLng(pixelY, pixelX);

        // Create a default Leaflet marker at that point
        var pin = L.marker(latlng).addTo(map);

        // 3) Bind a tooltip or popup on hover showing the marker’s ID
        if (m.tooltip === 'hover') {
          pin.bindTooltip(m.id, { permanent: false, direction: 'top' });
        } else if (m.description) {
          pin.bindPopup(m.description);
        } else {
          pin.bindTooltip(m.id, { permanent: false, direction: 'top' });
        }

        // 4) (OPTIONAL) Apply minZoom / maxZoom if provided:
        // if (m.minZoom !== null) pin.options.minZoom = m.minZoom;
        // if (m.maxZoom !== null) pin.options.maxZoom = m.maxZoom;
      }
    });

    // ▮ J) (OPTIONAL) Example of adding another manual marker:
    /*
    L.circleMarker(
      L.latLng(900, 300),
      { radius: 8, color: 'yellow', fillOpacity: 0.8 }
    )
    .addTo(map)
    .bindPopup('Manual marker at pixel (300, 900)');
    */
  </script>
</body>
</html>
